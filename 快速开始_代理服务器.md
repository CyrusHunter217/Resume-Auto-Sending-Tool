# API 代理服务器 - 快速开始指南

## 什么是 API 代理服务器？

API 代理服务器是一个中间层，用于保护你的 DeepSeek API Key：
- **客户端** → **你的代理服务器** → **DeepSeek API**
- API Key 只存储在服务器端，客户端完全看不到
- 可以控制访问、监控使用量、设置配额

## 快速部署（5分钟）

### 步骤 1：安装依赖

```bash
pip install flask flask-cors requests gunicorn
```

或者：

```bash
pip install -r api_proxy_requirements.txt
```

### 步骤 2：配置 API Key

编辑 `api_proxy_server.py`，找到这一行：

```python
DEEPSEEK_API_KEY = os.getenv('DEEPSEEK_API_KEY', 'sk-aa830600ff6b46839da3e59734f82c89')
```

或者设置环境变量：

```bash
# Windows
set DEEPSEEK_API_KEY=sk-你的API-Key

# Linux/Mac
export DEEPSEEK_API_KEY=sk-你的API-Key
```

### 步骤 3：运行服务器

**开发环境（测试用）：**
```bash
python api_proxy_server.py
```

**生产环境（推荐）：**
```bash
gunicorn -w 4 -b 0.0.0.0:5000 api_proxy_server:app
```

服务器会在 `http://localhost:5000` 启动

### 步骤 4：测试服务器

打开浏览器访问：`http://localhost:5000/health`

应该看到：`{"status": "ok", "message": "API Proxy Server is running"}`

### 步骤 5：配置客户端

编辑 `api_config.json`：

```json
{
  "api_key": "",
  "use_proxy": true,
  "proxy_url": "http://localhost:5000",
  "server_api_key": ""
}
```

如果服务器设置了认证，填写 `server_api_key`。

## 部署到云服务器

### 方式一：使用 Docker（最简单）

1. **构建镜像**
```bash
docker build -t api-proxy .
```

2. **运行容器**
```bash
docker run -d -p 5000:5000 \
  -e DEEPSEEK_API_KEY=sk-你的API-Key \
  -e SERVER_API_KEY=your-server-key \
  --name api-proxy \
  api-proxy
```

### 方式二：使用云服务（Heroku/Railway/Render）

**Heroku 部署：**
```bash
heroku create your-app-name
heroku config:set DEEPSEEK_API_KEY=sk-你的API-Key
git push heroku main
```

**Railway 部署：**
1. 连接 GitHub 仓库
2. 设置环境变量 `DEEPSEEK_API_KEY`
3. 自动部署

## 配置 HTTPS（生产环境）

使用 Nginx 作为反向代理：

1. **安装 Nginx 和 SSL 证书**
```bash
sudo apt install nginx certbot python3-certbot-nginx
sudo certbot --nginx -d your-domain.com
```

2. **配置 Nginx**（参考 `nginx_config_example.conf`）

3. **更新客户端配置**
```json
{
  "use_proxy": true,
  "proxy_url": "https://your-domain.com"
}
```

## 安全设置

### 1. 设置服务器认证密钥

在 `api_proxy_server.py` 中设置：

```python
SERVER_API_KEY = "your-strong-random-key-here"
```

客户端需要在 `api_config.json` 中配置相同的密钥。

### 2. 限制访问（可选）

可以添加 IP 白名单、请求频率限制等功能。

## 监控使用量

访问统计接口（需要认证）：

```bash
curl http://localhost:5000/api/stats \
  -H "Authorization: Bearer your-server-api-key"
```

返回：
```json
{
  "total_requests": 100,
  "total_tokens": 50000,
  "requests_today": 20,
  "last_reset_date": "2024-01-01"
}
```

## 客户端自动切换

客户端代码已经支持自动切换：
- 如果 `use_proxy: true`，使用代理服务器
- 如果 `use_proxy: false`，直接调用 DeepSeek API

无需修改客户端代码，只需修改配置文件即可。

## 常见问题

**Q: 代理服务器会影响速度吗？**
A: 影响很小，通常只增加 < 50ms 延迟

**Q: 如何更换 API Key？**
A: 只需在服务器端更新环境变量，客户端无需修改

**Q: 可以限制每个客户端的使用量吗？**
A: 可以，修改服务器代码添加配额功能

**Q: 如何收费？**
A: 通过统计接口查看使用量，按使用量收费

## 下一步

1. 部署服务器到云服务器
2. 配置 HTTPS 和域名
3. 设置访问控制
4. 更新客户端配置使用代理
5. 打包客户端时设置 `use_proxy: true`

详细说明请查看 `API代理服务器部署说明.md`

